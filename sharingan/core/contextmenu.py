import idaapi, ida_kernwin, idc
from PySide6 import QtWidgets

TODO_LIST = 'sharingan:todo'
FIND_OBFU = 'sharingan:find_obfu'
REVERT = 'sharingan:revert'
FIND_ICON_DATA = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00 \x00\x00\x00 \x08\x06\x00\x00\x00szz\xf4\x00\x00\x04\x1bIDATx\x01\xed\xc1]lSe\x18\x07\xf0\xff\xf3\xbc\xe7\xbc\xdd\x97+4`\xd8\xdc\x8a\xb8*"\xa2\xe5\xc3K!\x0c$\x08qw:\xdc\x8d\xe2\x10LHL\\\xb84^y\x89\x891Q\x98\xeb2\xf4\xca\x04\xa33\xd2)\xbb\x98|\xcb\xb4\xdb\xd8\xba\x84\xcd\xb0\xc0\xea\x1c\x13\xd8\xdaf\x85\xf5\x9c\x9e\xbe\xafga&\xa4\xd9F\'p\xe5~?,\xfa\xdf#,@\xa4\xbbg\x05\x11\xf9\x85`r\x9c\xec\xb5M\x1b\xd6\xff\x8d\x07D\xb8\x8f\xdeh\x7f\x11\x11\x1d$\xa2z!\xc43\x00\x08wi\xa5\xd4\x80\xcafC\xf1x\xfc\xc8\x96\xcd/O\xe1? \xcc\xa37\xda\x1f4\x0c\xe38\x11\x050\x0f\xa5\xd4`\xd6q^\x7f\xf1\x85uQ,\x90\xc0\x1cz\xa3\xfdA\xc30N\x11Q9\\Z\xeb)\xdb\xb6\x7f\x98\x18\x1f\xff\xe6\xf6\x9d;\xa7\x0ca\xc4\x850V\x11\xc1 \xd02!D\xed\xbe\xfd\xef\xb65\x1e=z\x03\x0b 0\x8bK}\xd1"\xd34;\x88\xa8\x1c\xaeL&\x13\x1e\x19\x19\xd9\xe1\xf5z\x7f.(,\xbcVXX4H\xcc?\x8e\x8d]\xff\xbc\xa0\xa0`\x8d0D\x00@!3W\xbfQ\xbb\xa7\xf9XK\x8b\x83<1f\xc1\xcc\x07\x89(\x00\x97eY\'R\xa9T\xad\xbf\xd2_i\x08c\x8di\x98+L\xc3x\xdc4\x8d@yy\xb9_k]g\xdb\xf6I\xb8\x98\xf8Y\x9f\xcfw\x00\x0b\xc0\x98\x05\x11\xd5\xc3\xa5\xb5\x9e\x8a\r\x0f\xef/-\xf5>GD%\xc8AD\xd24\xcd\xb5\x13\x13\x13\xef)\xad\xd2p1\xf3\xbe\xc6\xa6&\xe4\x8b\x91\xa3\xab\xa7\xa7L\x08\xb1\x1a.\xdb\xb6\xc3\x95~\xbf%\x98\xbd\xb8\x17\x91\xce\xb8R\xa9\x94-\x84\xc1R\xca\xdb\x96e\xb5\xc3\xc5\xcck\x03\x81\xa7\x97#O\x06r\x18\x86\xb9\x123\x92\x89D\xef\x92\xa5\xbe%\x98\xe1d\x9dD<\x1e\x1f\x1e\x1c\x18\x88\xb7\xb6~\xef\xb4\x85\xc3\xd8\xb5{7\xda\xc2at\xfe\x1e\xe9\x05P\x03\r\x92RV\x02\xb8\x89<\x18\xc8\xa1]\xf8\x17M\x03\x83\x00\xcb\xb2\x86._\xbe|\xb5nO-\xee\xd5\x16\x0e\xe3A\x18\xc8\x91u\xb21Hh\x00TTT\x14\xd4Z\x1fKO\xa5\x87\xab\xb7n\xb9\x9aH$0\x17)e\x10\xd3\x08\xcaJ\xa7c\xc8\x13#\xc7\xc6\r\xc1\xebJ\xa9A\xb8J\x8aK^M&\x93\xc6\xc5\xce_\xaf$\x12\t\xcc\xe5\xc2\xc5N\xbfi\x9a;@\x80\xe38\xfd\xb1\xd8\xf0-\xe4\x891\x1b\x8d&L#\x14z\xbd\xde/V=\xb9J`\x0e\xe7\xce_\x90\xc5\xc5\xc5\xcd\xcc\xe4\x014\x1c\xc7izg\xef^\xe4\x8b1\x8b\xf1\xf1\xf1#J\xa9?\xa0\x01)\xe5\xce\'**N\x9c9{\xbe\x129N\x9f9\xbb\xf2\xb1\xd2\xd26\xd34\xb7\x03\x84\x91\x9b\x93\xd9\x0f[~\xe9\xc0\x02\x10\xe6p\xa9/\xbaN\x9a\xf24\x08K\xe1RJ\xa53\xb6}2mY}py<\x9e\xa0\x94r\x073{\xe0\x9a\xbcc\xe1\xa3\xaf\xce na(\x9bIo\xedj>\xf4\'\xf2@\x98GOo\xdf\xf3\xa6i~\xcb\xcc\xab1\x8f\xbfnMf\x0f\x1f\xbf(&\xd2\x1a,\x04\xb4VCY;]\xdd\xd5|(\x86\xfb\x10\x98G\xe3\xd1#7\xf6\xbcY\x17\x92R\xde\xd2ZW0\xf3r\x00\x84\xbb\x94\xe38\xd1L\xc6\xfe\xf8\xd3\xef:?\x18\xbb\xadw\xb1\x10>\xb8\x88\xc8GB\xd4\x94\x05\xb7\xb5\x8ev\xb7\'1\x0fB\x9e\xbe\x0c\x85P\xf5T\xd52\xe9\xf1T\x02\xa0\xd4\xe4\xe4\xf0\xd8\xd8\xd8\xf8\xde\xb7\xdf\xc2\xb4\x8d\xf5\x87\xfdB\x16t\x10q\x15fh\xad\x86T\xc6\xae\x8e\x84\x1ab\x98\x03\xe1!\xdaT\xff\x89\x9f\xa5\xa7\x83\x88\xab0Ck5\xa42vu$\xd4\x10\xc3,\x04\x1e\xa2\xd1\x9e\xf6dYp[+\xb1\xa8!"\x1f\\D\xe4#\xe6\x9a\xb2\xf5\xaf\xb4\x8ev\x9fL"\x87\xc0C6\xda\xdd\x9e,\x0bno%\xe6\x1a"\xf2\xc1ED>b~\xad|\xe3\xce\xafG\xbb~\xb2p\x0f\xc6#\x10\t5\xc4T\xc6\xae\xd6Z\ra\x06\x11\x07\x08\xb4\x059\x18\x8fH$\xd4\x10SNf\xab\xd6\xea\n\xee\x9a\x00t\x049\x08\x8f\xd8K\x07>\xf3\x02\xb4\x99\xa0#\xbf5\xbe\x7f\x1d\x8b\x16\xe5\xf8\x07Q.\xa9\xac\x94\x08X\xd9\x00\x00\x00\x00IEND\xaeB`\x82'
FIND_ICON = ida_kernwin.load_custom_icon(data=FIND_ICON_DATA, format='png')
TODO_ICON_DATA = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00 \x00\x00\x00 \x08\x06\x00\x00\x00szz\xf4\x00\x00\x03\xb5IDATx\x01\xed\xc1Ol\x93e\x1c\xc0\xf1\xef\xefy\xde\xb6t\x07\xd9a\x83\x1b#\x81d\x1a\xbdpY"\x18\xde\x01\x19\xc6\x04\xb3\x9590\xf1\x80!D\xc2\xc5SmG\xe2\x95\xad%\x1e<\xf8\'\x19\x17O\xd6\xaeaR\xbc\xb0S\xab\x19\xc2\xc1hB"\x92\x91\xe88 `p\x93\x98\xc1H\xfb>?\xaby\xd5\xd2\xb4\xa5\xfbs\xd3\xcf\x87\xff<a\rR3~\xafgM\xbf\x08=\xfcIY\x0c\xaaz33Z\xbe\xc3*\t\x1dJ\xcf\xf8;\xbc\x88=!J\x02\xa1\x9f&T\xf9\t\xb8P\xad\x04\xe7\xb2\xa3_\xfe@\x07\x84\xa7H\x15\xfc^/j2\xc6\xc81\xc0\xd2\x19\xe7\x02\x9d\x0eT\x93\xd9D\xf96m\x08m\x8c\xcf\x0c\xee\xf7<\x93C\xd8\xc2Z(KA\xd5\xbd9y\xb8|\x91\x16,-\x9c\xfe|\xdf\x11/bf\x10\x9ea\xad\x84\xb8\xb1rt\xcfX\xdf\xcfs\xf9\x85oi\xc2\xd2\xc4\xf8\xcc\xe0~/bf\x80\x08\xeb\'\xc6\xca\xa1=c}\xd7\xe6\xf2\x0b7h`h\x90*\xf8\xbd\x9egr@\x84\x8dcl\xc4|\x92\x9e\xf1\xb7\xd1\xc0\xd0\xc0\x8b\x9a\x0c\xc2\x166\xdefk\xcd\xfb40\xd4I\x17\xfc\x1d\xc6\xc816\x82\xf2\x88\x06\xc6\xc8H\xfa\xbc\xbf\x8b:\x86:^\xd4\x9c\x00,\xeb\xa4NO\xaf<\xac\xeeUe\x89\'\x89\x17\xb1\'\xa9c\xa8\'\x92`\x9d\xd4\xe9\xe93\xc3\xa5\xcc{\xaf\x7f\xf5\xcd\xe3\x87\xd5a@\xa9#0\x92\xca\xef\x15B\x86P\xea\xa2\xdf+B?\xeb\xe0\x9c\x8e\x9f\x19.e\xa8y\'?\x18\x8f\xc5\xbdw\x01\xa1\x9e\xb0\xd5D\xedNB\x86\x90\xa7\xa6\x9f\x16TY\xaeT\xf4\xa4\xc2=ZP\xa7\xe3\x13\xc3\xa5,5\xc9\xcf\xfcxt\x93\xb9 \x86\x834a\xad\xf4\x132\x84D\xa4\x87&TY\xae>\x0e^\xcd\x1e.M=\x88\xae\x1cp\xa2\xf7h\xe0\x02\x1d?3\\\xcaR\x93\xcc\xf9\xf1X\xdc\x16\xc5p\x90\x96\xb4\x87\x90\xe1\x1fJ3\x02U\x85ej>x\xf9\xeb\xef\x1f<X\xd9\xef\x02\xbdK\xc89MO\x8c\x94\xb2\xd4$s~<\xd6e\x8bb\x18\xa2-\xe1o\x86\x7f-\xd2\x8c\xb09\x12\xb3\xb3\xa9\x82?@\xcd\x87o\\\xb9\xfe\xdb/+\x07\\\xa0w]\xa0\xe9\x89\xe1\xd2Yj\x929?\x1e\xeb\xb2E1\x0c\xf1t\x8b\x84\x0c\xa1jEo\xd2\x82\x08\xdd\x91\x98\x9dM\x15\xfc\x01j>z\xeb\xca\xf5\xa5;\x8f\x9e\x9f\x18)\x9d\xa5&\x99\xf3\xe3\xb1.[\x14\xc3\x10\x1dp\x81\xce\x132\x84\xb2\xa3\xe5;\xaa\xfcH\x0b"tGbv6U\xf0\x07\xa8\xf9\xf8\xd4\xd5Ej\x929?\x1e\xeb\xb2E1\x0c\xd1\t\xe5\xbe\xab2O\xc8\xf0\xa4"m\x88\xd0\x1d\x89\xd9\xd9T\xc1\x1f\xa0&\x99\xf3\xe3\xb1.[\x14\xc3\x10\x1dR\xf8";Vr\x84\x0cu\xaa\x95\xe0\x1c\xe0hC\x84\xeeH\xcc\xce\xa6\xa6}?\xd6e\x8bb\x18b\x15\x82\x8a\x9b\xa2\x8e\xa5\xce\xe5\xe9[\xf7_:\xba\xfd91\xf2\x02m\x88\xb0\xc9F\xcc1\x11v\xb0\n\xce\xe9\xa5\xc9D9K\x1dC\x83@]\x12e\x89\xa7\x13Vg\xd99}\x9b\x06\x96\x06\x97\xf3\xb7~\xdf=\xd6w\xddX9\n\x08\x1bC\x83\xaa;\x9eI\x94\xcb4\xb041\x97_\x98\xdfsd\xfbmc\xe4\x10 \xac\x8f\xba@\x93\x93\x89\xf2\x14MXZ\x98\xcb/|\xb7\xfbH\xdf5c\xe4\x15`\x13k\xb3\x1cT\xf5\xf8d\xa24E\x0b\x966\xe6\xf2\x0b7^\x1c\xdb\xf6\xa9\x88\xf4\x89\xc8\xb3\x80\xd0!\xe7\xf4R\x10\xe8H&Q.\xd3\x86\xd0\xa1\xf1\xf3\x83\xbbl\xc4\x9c\x14\x18A\xd8J3\xca\xaf\n\x17\x83\x8a\x9b\xca\x8c\x96\xaf\xd2\x01a\x95\xd2\xd3\xfb\xc4Fe\xa7\x18\xed\x07\xe9\xe1/\xba\xe8\x02\xe6\x83@\xe7\xcf\xbeVv\xfco\x15\xfe\x00\xd6KY(\xa1w\x0c\xd6\x00\x00\x00\x00IEND\xaeB`\x82'
TODO_ICON = ida_kernwin.load_custom_icon(data=TODO_ICON_DATA, format='png')
EXCLUSION_ICON_DATA = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00 \x00\x00\x00 \x08\x06\x00\x00\x00szz\xf4\x00\x00\x01\xdaIDATx\x01\xc5\xc11oUe\x18\x00\xe0\xe7{{kK\x8aH\x00),\x18\x12\t\x8b\xe9H\x82\x89\x83,\xb0\xe3\x9f`\xe7\x178\xb8\xe1\x8f\xf0\'08ti\xa2\x83\xc6\xddD6b !!\xe7\x1cZ\x9b\x86\xf6\x9e{>\x16\x86\xcb\xf1\xfb\xf0\x1aN\xc3\xf3$+\xea\xac\x7fu\x96\xdf\x13[\xde\xef\xf5!w\xce\x9b\xfff\x05aE\x89\xeb\x89-\xffm3\xf8\xd2\x8a\xc2G6\xb3\xa2=\xc3n\x96\xb6\xad \xc9\x07V\x94\x8c\xbc\xb0\xbe\xbe\xc9\xe7\x89dB\x19\'\xbc\xbcl~bI\xb2\xe4\xd8\xfa\xad\xe0qb\xdb)\xc8\xb4\x03\xdfm\x98\xefy+,\t\xbeOl;%\x89\x0b\xc1\x0f\x96\x84w]t\xfa.Y\x12>\xb2\x99%?\x19\xbeN\x84S\x94\xc9\x96$\x05\x7f\x9b]\x0b\xce\x9a\xd0\xc0\xd15\xfdS#3\x05W\xa4\x1f\x83\xfb&4\xb0\x8b\xbbFBYgz\x8d\x82P\x90iU\x9c\xf0\xd7\xc0\xbe\x91\x05\x87\xc7\xfc\xa9"\xd3(\x08e\x9d\x82\x05\xaf~\x91w\x0ex`\xe4\x88\x87\x7fX\xec\x1c\xf3\\Y\xab \x14d:\x05k\x1c\xdd\xd3\xcfI\xfbFz\x0e\xbe5\x0c=\x87\xca\x1a\x05\xa1\xac5\xb1L\xab \x14\x0ct&\x96i\x14\x84\x82\x81\xd6\xc42\x8d\x82P0\xd0\x99XO\xab \x14\x1c\xc9\x9d\x89\xbd\x96\x1b\x05\xa1\xe0\x1f\xf9 \xd3\xfb\x7f\xb2\x8aL\xdf\xb1\xaf \x14\xdc\xb0\x182\xfb&\x92yuS?(\x08u\xad\xe94*B]g:\xad\x8aP\xd7\x9aH\xa6Q\x11*2\x9d\xe9\xb4*B]kd\xc1\xd6\xcf\xd66\x92|\xd1Hpa\xd7\xdal\xc69\xff\xd6\xa8\x98\xa9\xc8tF\xd6\xf8\xec\x1b\xf1\xe4\x13.\x19\xf9\x94G\xb7\xc5\xc3\r\xae\x1a\xc94*f\xea:\x05g\xf8BA\xb0y\x86\xeb\n2\xad\x8aP\x91iM\xa7Q\x11*z\xf62/|\xa0\xcc\xb39\xbf\xaax\x03\xdcT\x95\xe8\xe3\xb6\x1a\xea\x00\x00\x00\x00IEND\xaeB`\x82'
EXCLUSION_ICON = ida_kernwin.load_custom_icon(data=EXCLUSION_ICON_DATA, format='png')

class InputDialog(QtWidgets.QDialog):
    def __init__(self):
        super(InputDialog, self).__init__()
        self.setWindowTitle(f"Input hint")
        self.layout = QtWidgets.QVBoxLayout()
        
        self.textbox = QtWidgets.QLineEdit()
        self.layout.addWidget(QtWidgets.QLabel("Hint:"))
        self.layout.addWidget(self.textbox)
        
        self.buttons = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel)
        self.buttons.accepted.connect(self.accept)
        self.buttons.rejected.connect(self.reject)
        self.layout.addWidget(self.buttons)
        
        self.setLayout(self.layout)
    
    def get_value(self):
        return self.textbox.text()

class HookRightClick(idaapi.UI_Hooks):
    def finish_populating_widget_popup(self, widget, popup):
        if idaapi.get_widget_type(widget) == ida_kernwin.BWN_DISASM:
            ida_kernwin.attach_action_to_popup(widget, popup, TODO_LIST, None, 0)
            ida_kernwin.attach_action_to_popup(widget, popup, FIND_OBFU, None, 0)
            ida_kernwin.attach_action_to_popup(widget, popup, REVERT, None, 0)
        return 0
    
class handler_add_todo(idaapi.action_handler_t):
    def __init__(self):
        super().__init__()
        self.recipe = None
        self.start_ea = 0
        self.end_ea = 0

    def add_recipe(self, recipe):
        self.recipe = recipe

    def activate(self, ctx):
        if self.recipe:
            if idc.read_selection_start() != idaapi.BADADDR:
                self.start_ea = idc.read_selection_start()
                self.end_ea = idc.read_selection_end()
            else:
                self.start_ea = self.end_ea = idaapi.get_screen_ea()
            dialog = InputDialog()
            if dialog.exec_():
                hint = dialog.get_value()
                self.recipe.append_addr_combobox(f'{hex(self.start_ea)} - {hex(self.end_ea)} - {hint}')
        else:
            print('Please run plugin first')

    def update(self, ctx):
        return idaapi.AST_ENABLE_ALWAYS
    
class handler_find_obfus(idaapi.action_handler_t):
    def __init__(self):
        super().__init__()
        self.recipe = None

    def add_recipe(self, recipe):
        self.recipe = recipe

    def activate(self, ctx):
        if self.recipe:
            self.recipe.scan()
        else:
            print('Please run plugin first')

    def update(self, ctx):
        return idaapi.AST_ENABLE_ALWAYS
    
class handler_exclusion(idaapi.action_handler_t):
    def __init__(self):
        super().__init__()
        self.recipe = None

    def add_recipe(self, recipe):
        self.recipe = recipe

    def activate(self, ctx):
        if self.recipe:
            cursor = idaapi.get_screen_ea()
            self.recipe.exclude_fp(cursor)
        else:
            print('Please run plugin first')

    def update(self, ctx):
        return idaapi.AST_ENABLE_ALWAYS
    
class InitHookMenu():
    def __init__(self):
        self.handler_todo = handler_add_todo()
        self.handler_find = handler_find_obfus()
        self.handler_exclusion = handler_exclusion()
        action_add_todo = idaapi.action_desc_t(TODO_LIST, 'Add todo list', self.handler_todo, None, None, TODO_ICON)
        action_find_obfu = idaapi.action_desc_t(FIND_OBFU, 'Find obfuscated code', self.handler_find, None, None, FIND_ICON)
        action_exclusion = idaapi.action_desc_t(REVERT, 'Exclude', self.handler_exclusion, None, None, EXCLUSION_ICON)
        assert idaapi.register_action(action_add_todo), 'Action registration failed'
        assert idaapi.register_action(action_find_obfu), 'Action registration failed'
        assert idaapi.register_action(action_exclusion), 'Action registration failed'
        self.hook_menu = HookRightClick()
        self.hook_menu.hook()

    def cleanup(self):
        self.hook_menu.unhook()
        idaapi.unregister_action(TODO_LIST)
        idaapi.unregister_action(FIND_OBFU)
        idaapi.unregister_action(REVERT)

    def register_recipe(self, recipe):
        self.handler_todo.add_recipe(recipe)
        self.handler_find.add_recipe(recipe)
        self.handler_exclusion.add_recipe(recipe)