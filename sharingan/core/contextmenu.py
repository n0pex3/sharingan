import idaapi
from PySide6.QtWidgets import QDialog, QVBoxLayout, QLineEdit, QLabel, QDialogButtonBox
import re


BOOKMARK_LIST = 'sharingan:bookmark'
REVERT = 'sharingan:revert'
FILTER = 'sharingan:filter_'
BOOKMARK_ICON_DATA = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00 \x00\x00\x00 \x08\x06\x00\x00\x00szz\xf4\x00\x00\x03\xb5IDATx\x01\xed\xc1Ol\x93e\x1c\xc0\xf1\xef\xefy\xde\xb6t\x07\xd9a\x83\x1b#\x81d\x1a\xbdpY"\x18\xde\x01\x19\xc6\x04\xb3\x9590\xf1\x80!D\xc2\xc5SmG\xe2\x95\xad%\x1e<\xf8\'\x19\x17O\xd6\xaeaR\xbc\xb0S\xab\x19\xc2\xc1hB"\x92\x91\xe88 `p\x93\x98\xc1H\xfb>?\xaby\xd5\xd2\xb4\xa5\xfbs\xd3\xcf\x87\xff<a\rR3~\xafgM\xbf\x08=\xfcIY\x0c\xaaz33Z\xbe\xc3*\t\x1dJ\xcf\xf8;\xbc\x88=!J\x02\xa1\x9f&T\xf9\t\xb8P\xad\x04\xe7\xb2\xa3_\xfe@\x07\x84\xa7H\x15\xfc^/j2\xc6\xc81\xc0\xd2\x19\xe7\x02\x9d\x0eT\x93\xd9D\xf96m\x08m\x8c\xcf\x0c\xee\xf7<\x93C\xd8\xc2Z(KA\xd5\xbd9y\xb8|\x91\x16,-\x9c\xfe|\xdf\x11/bf\x10\x9ea\xad\x84\xb8\xb1rt\xcfX\xdf\xcfs\xf9\x85oi\xc2\xd2\xc4\xf8\xcc\xe0~/bf\x80\x08\xeb\'\xc6\xca\xa1=c}\xd7\xe6\xf2\x0b7h`h\x90*\xf8\xbd\x9egr@\x84\x8dcl\xc4|\x92\x9e\xf1\xb7\xd1\xc0\xd0\xc0\x8b\x9a\x0c\xc2\x166\xdefk\xcd\xfb40\xd4I\x17\xfc\x1d\xc6\xc816\x82\xf2\x88\x06\xc6\xc8H\xfa\xbc\xbf\x8b:\x86:^\xd4\x9c\x00,\xeb\xa4NO\xaf<\xac\xeeUe\x89\'\x89\x17\xb1\'\xa9c\xa8\'\x92`\x9d\xd4\xe9\xe93\xc3\xa5\xcc{\xaf\x7f\xf5\xcd\xe3\x87\xd5a@\xa9#0\x92\xca\xef\x15B\x86P\xea\xa2\xdf+B?\xeb\xe0\x9c\x8e\x9f\x19.e\xa8y\'?\x18\x8f\xc5\xbdw\x01\xa1\x9e\xb0\xd5D\xedNB\x86\x90\xa7\xa6\x9f\x16TY\xaeT\xf4\xa4\xc2=ZP\xa7\xe3\x13\xc3\xa5,5\xc9\xcf\xfcxt\x93\xb9 \x86\x834a\xad\xf4\x132\x84D\xa4\x87&TY\xae>\x0e^\xcd\x1e.M=\x88\xae\x1cp\xa2\xf7h\xe0\x02\x1d?3\\\xcaR\x93\xcc\xf9\xf1X\xdc\x16\xc5p\x90\x96\xb4\x87\x90\xe1\x1fJ3\x02U\x85ej>x\xf9\xeb\xef\x1f<X\xd9\xef\x02\xbdK\xc89MO\x8c\x94\xb2\xd4$s~<\xd6e\x8bb\x18\xa2-\xe1o\x86\x7f-\xd2\x8c\xb09\x12\xb3\xb3\xa9\x82?@\xcd\x87o\\\xb9\xfe\xdb/+\x07\\\xa0w]\xa0\xe9\x89\xe1\xd2Yj\x929?\x1e\xeb\xb2E1\x0c\xf1t\x8b\x84\x0c\xa1jEo\xd2\x82\x08\xdd\x91\x98\x9dM\x15\xfc\x01j>z\xeb\xca\xf5\xa5;\x8f\x9e\x9f\x18)\x9d\xa5&\x99\xf3\xe3\xb1.[\x14\xc3\x10\x1dp\x81\xce\x132\x84\xb2\xa3\xe5;\xaa\xfcH\x0b"tGbv6U\xf0\x07\xa8\xf9\xf8\xd4\xd5Ej\x929?\x1e\xeb\xb2E1\x0c\xd1\t\xe5\xbe\xab2O\xc8\xf0\xa4"m\x88\xd0\x1d\x89\xd9\xd9T\xc1\x1f\xa0&\x99\xf3\xe3\xb1.[\x14\xc3\x10\x1dR\xf8";Vr\x84\x0cu\xaa\x95\xe0\x1c\xe0hC\x84\xeeH\xcc\xce\xa6\xa6}?\xd6e\x8bb\x18b\x15\x82\x8a\x9b\xa2\x8e\xa5\xce\xe5\xe9[\xf7_:\xba\xfd91\xf2\x02m\x88\xb0\xc9F\xcc1\x11v\xb0\n\xce\xe9\xa5\xc9D9K\x1dC\x83@]\x12e\x89\xa7\x13Vg\xd99}\x9b\x06\x96\x06\x97\xf3\xb7~\xdf=\xd6w\xddX9\n\x08\x1bC\x83\xaa;\x9eI\x94\xcb4\xb041\x97_\x98\xdfsd\xfbmc\xe4\x10 \xac\x8f\xba@\x93\x93\x89\xf2\x14MXZ\x98\xcb/|\xb7\xfbH\xdf5c\xe4\x15`\x13k\xb3\x1cT\xf5\xf8d\xa24E\x0b\x966\xe6\xf2\x0b7^\x1c\xdb\xf6\xa9\x88\xf4\x89\xc8\xb3\x80\xd0!\xe7\xf4R\x10\xe8H&Q.\xd3\x86\xd0\xa1\xf1\xf3\x83\xbbl\xc4\x9c\x14\x18A\xd8J3\xca\xaf\n\x17\x83\x8a\x9b\xca\x8c\x96\xaf\xd2\x01a\x95\xd2\xd3\xfb\xc4Fe\xa7\x18\xed\x07\xe9\xe1/\xba\xe8\x02\xe6\x83@\xe7\xcf\xbeVv\xfco\x15\xfe\x00\xd6KY(\xa1w\x0c\xd6\x00\x00\x00\x00IEND\xaeB`\x82'
BOOKMARK_ICON = idaapi.load_custom_icon(data=BOOKMARK_ICON_DATA, format='png')
EXCLUSION_ICON_DATA = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00 \x00\x00\x00 \x08\x06\x00\x00\x00szz\xf4\x00\x00\x01\xdaIDATx\x01\xc5\xc11oUe\x18\x00\xe0\xe7{{kK\x8aH\x00),\x18\x12\t\x8b\xe9H\x82\x89\x83,\xb0\xe3\x9f`\xe7\x178\xb8\xe1\x8f\xf0\'08ti\xa2\x83\xc6\xddD6b !!\xe7\x1cZ\x9b\x86\xf6\x9e{>\x16\x86\xcb\xf1\xfb\xf0\x1aN\xc3\xf3$+\xea\xac\x7fu\x96\xdf\x13[\xde\xef\xf5!w\xce\x9b\xfff\x05aE\x89\xeb\x89-\xffm3\xf8\xd2\x8a\xc2G6\xb3\xa2=\xc3n\x96\xb6\xad \xc9\x07V\x94\x8c\xbc\xb0\xbe\xbe\xc9\xe7\x89dB\x19\'\xbc\xbcl~bI\xb2\xe4\xd8\xfa\xad\xe0qb\xdb)\xc8\xb4\x03\xdfm\x98\xefy+,\t\xbeOl;%\x89\x0b\xc1\x0f\x96\x84w]t\xfa.Y\x12>\xb2\x99%?\x19\xbeN\x84S\x94\xc9\x96$\x05\x7f\x9b]\x0b\xce\x9a\xd0\xc0\xd15\xfdS#3\x05W\xa4\x1f\x83\xfb&4\xb0\x8b\xbbFBYgz\x8d\x82P\x90iU\x9c\xf0\xd7\xc0\xbe\x91\x05\x87\xc7\xfc\xa9"\xd3(\x08e\x9d\x82\x05\xaf~\x91w\x0ex`\xe4\x88\x87\x7fX\xec\x1c\xf3\\Y\xab \x14d:\x05k\x1c\xdd\xd3\xcfI\xfbFz\x0e\xbe5\x0c=\x87\xca\x1a\x05\xa1\xac5\xb1L\xab \x14\x0ct&\x96i\x14\x84\x82\x81\xd6\xc42\x8d\x82P0\xd0\x99XO\xab \x14\x1c\xc9\x9d\x89\xbd\x96\x1b\x05\xa1\xe0\x1f\xf9 \xd3\xfb\x7f\xb2\x8aL\xdf\xb1\xaf \x14\xdc\xb0\x182\xfb&\x92yuS?(\x08u\xad\xe94*B]g:\xad\x8aP\xd7\x9aH\xa6Q\x11*2\x9d\xe9\xb4*B]kd\xc1\xd6\xcf\xd66\x92|\xd1Hpa\xd7\xdal\xc69\xff\xd6\xa8\x98\xa9\xc8tF\xd6\xf8\xec\x1b\xf1\xe4\x13.\x19\xf9\x94G\xb7\xc5\xc3\r\xae\x1a\xc94*f\xea:\x05g\xf8BA\xb0y\x86\xeb\n2\xad\x8aP\x91iM\xa7Q\x11*z\xf62/|\xa0\xcc\xb39\xbf\xaax\x03\xdcT\x95\xe8\xe3\xb6\x1a\xea\x00\x00\x00\x00IEND\xaeB`\x82'
EXCLUSION_ICON = idaapi.load_custom_icon(data=EXCLUSION_ICON_DATA, format='png')
FILTER_ICON_DATA = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x10\x00\x00\x00\x10\x08\x03\x00\x00\x00(-\x0fS\x00\x00\x00oPLTEGpL\x05}\x8d\t)Z\x08*[\x07Jn\t)[\x05t\x88\x08-\\\x08:d\x06f\x7f\x080^\x07Vu\x085a\x085a\x089d\t%W\x07Dj\x085a\x080^\x08Bi\x08Ai\x04\x89\x94\x00\xef\xd1\x00\xf1\xd2\x06j\x81\x00\xe6\xcc\x00\xee\xd1\x02\xbe\xb4\x00\xe3\xca\x04\x9b\x9e\x04\x99\x9d\x01\xdb\xc5\x06Zx\x02\xcc\xbc\x01\xcd\xbd\x03\xa9\xa7\x03\xab\xa8\x00\xf9R\xa2\x00\x00\x00\x16tRNS\x00\xf358\xbe\x15\xf1"\x86\xe4N\xd1ur\xc3\t\xe1+_\x9f\x9d\xf9$\xa3})\x00\x00\x00tIDAT\x18\xd3\xa5\xceG\x12\x830\x10D\xd1\x96%$rp\xa0\r\x12\xd1\xbe\xff\x19\xa1@\x85)oy\xbb\xf9\xd5\x8bA>\xbeO\xc6\x1c\x99p\xcd\xc1\x89\x14\xc5\xf3\xc3\xda\xe3\xf7Q\x00&\x99|\xe1\x9c\x18\xacb\xed\xb6\xc2F\xc7\xd8\x84\xfd\xbe\xe8\xc2\xfdF\xa0\xec:\xa1U\x81\x0f\x90\xd1@\x0e\x91\xc4!\xeb\xc9.\xfd\xdd\xb8\x89\xb6\x15\xf2j\xe0_\xd0\xf6\xa5\xcc)T\xa5\xba\xfb\xaf\x16\x80\x97\nB,\x06o\xaa\x00\x00\x00\x00IEND\xaeB`\x82'
FILTER_ICON = idaapi.load_custom_icon(data=FILTER_ICON_DATA, format='png')


class HintDialog(QDialog):
    def __init__(self):
        super().__init__()
        self.setWindowTitle(f"Input hint")
        self.layout = QVBoxLayout()
        
        self.txt_hint = QLineEdit()
        self.btn_ok = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok)
        self.btn_ok.accepted.connect(self.accept)
        self.layout.addWidget(QLabel("Hint:"))
        self.layout.addWidget(self.txt_hint)
        self.layout.addWidget(self.btn_ok)
        self.setLayout(self.layout)
    
    def get_hint(self):
        return self.txt_hint.text()


class HookRightClick(idaapi.UI_Hooks):
    def finish_populating_widget_popup(self, widget, popup, ctx):
        if idaapi.get_widget_type(widget) == idaapi.BWN_DISASM:
            idaapi.attach_action_to_popup(widget, popup, BOOKMARK_LIST, None, 0)
            idaapi.attach_action_to_popup(widget, popup, REVERT, None, 0)
            idaapi.attach_action_to_popup(widget, popup, FILTER, None, 0)
        return 0


class HandlerBookmark(idaapi.action_handler_t):
    def __init__(self):
        super().__init__()
        self.start_ea = 0
        self.end_ea = 0

    def register_recipe(self, recipe):
        self.recipe = recipe

    def activate(self, ctx):
        if self.recipe:
            valid_sel, start_ea, end_ea = idaapi.read_range_selection(None)
            if valid_sel:
                self.start_ea = start_ea
                self.end_ea = end_ea
            else:
                self.start_ea = self.end_ea = idaapi.get_screen_ea()
            dgl_hint = HintDialog()
            if dgl_hint.exec_():
                hint = dgl_hint.get_hint()
                if re.fullmatch(r'[a-zA-Z0-9\s]+', hint):
                    self.recipe.append_bookmark(self.start_ea, self.end_ea, hint)
                else:
                    print('Invalid character hint')
        else:
            print('Please run plugin first')

    def update(self, ctx):
        return idaapi.AST_ENABLE_ALWAYS


class HandlerExclusion(idaapi.action_handler_t):
    def __init__(self):
        super().__init__()

    def register_recipe(self, recipe):
        self.recipe = recipe

    def activate(self, ctx):
        if self.recipe:
            cursor = idaapi.get_screen_ea()
            self.recipe.exclude_patch_false_positive(cursor)
        else:
            print('Please run plugin first')

    def update(self, ctx):
        return idaapi.AST_ENABLE_ALWAYS


class HandlerFilter(idaapi.action_handler_t):
    def __init__(self):
        super().__init__()

    def register_recipe(self, recipe):
        self.recipe = recipe

    def activate(self, ctx):
        if self.recipe:
            valid_sel, start_ea, end_ea = idaapi.read_range_selection(None)
            if valid_sel:
                self.start_ea = start_ea
                self.end_ea = end_ea
            else:
                self.start_ea = self.end_ea = idaapi.get_screen_ea()
            self.recipe.add_ingredient_substitute(self.start_ea, self.end_ea)
        else:
            print('Please run plugin first')
    
    def update(self, ctx):
        return idaapi.AST_ENABLE_ALWAYS


class InitHookMenu():
    def __init__(self):
        self.handler_bookmark = HandlerBookmark()
        self.handler_exclusion = HandlerExclusion()
        self.handler_filter = HandlerFilter()
        action_bookmark = idaapi.action_desc_t(BOOKMARK_LIST, 'Bookmark', self.handler_bookmark, None, None, BOOKMARK_ICON)
        action_exclusion = idaapi.action_desc_t(REVERT, 'Exclude', self.handler_exclusion, None, None, EXCLUSION_ICON)
        action_filter = idaapi.action_desc_t(FILTER, 'Filter', self.handler_filter, None, None, FILTER_ICON)
        assert idaapi.register_action(action_bookmark), 'Action bookmark registration failed'
        assert idaapi.register_action(action_exclusion), 'Action exclusion registration failed'
        assert idaapi.register_action(action_filter), 'Action filter_ register failed'
        self.hook_menu = HookRightClick()
        self.hook_menu.hook()

    def cleanup(self):
        self.hook_menu.unhook()
        idaapi.unregister_action(BOOKMARK_LIST)
        idaapi.unregister_action(REVERT)
        idaapi.unregister_action(FILTER)

    def register_recipe(self, recipe):
        self.handler_bookmark.register_recipe(recipe)
        self.handler_exclusion.register_recipe(recipe)
        self.handler_filter.register_recipe(recipe)